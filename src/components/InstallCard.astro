---
/**
 * InstallCard - Inline card to prompt PWA installation
 * Hidden if app is already installed or user dismissed it
 */
---

<div id="install-card" class="install-card">
  <div class="flex items-center gap-3">
    <div class="shrink-0 size-11 rounded-xl bg-(--color-primary)/10 flex items-center justify-center">
      <span class="material-symbols-outlined text-(--color-primary) text-[22px]">download</span>
    </div>
    <div class="flex-1 min-w-0">
      <h3 class="text-sm font-bold text-(--color-text)">Install the app</h3>
      <p class="text-xs text-(--color-text-secondary)">Quick access from home screen</p>
    </div>
    <button id="install-card-btn" class="shrink-0 btn-primary py-2 px-3 text-xs">
      Install
    </button>
    <button id="install-card-dismiss" class="shrink-0 p-1.5 text-(--color-text-secondary) hover:text-(--color-text) transition-colors">
      <span class="material-symbols-outlined text-[18px]">close</span>
    </button>
  </div>
</div>

<style>
  .install-card {
    display: none;
    background: var(--color-surface);
    border: 1px solid var(--color-border-light);
    border-radius: var(--radius-xl);
    padding: 0.875rem;
  }

  .install-card.show {
    display: block;
  }
</style>

<script>
  import { initPwaInstall, triggerInstall } from '../lib/pwaInstall';

  // Separate localStorage key for inline card (independent from modal popup)
  const CARD_DISMISSED_KEY = 'hostelguide_install_card_dismissed';

  // Initialize PWA install capture
  initPwaInstall();

  const card = document.getElementById('install-card');
  const installBtn = document.getElementById('install-card-btn');
  const dismissBtn = document.getElementById('install-card-dismiss');

  // Check if should show card
  function checkAndShowCard() {
    if (!card) return;

    // Check if already in standalone mode (installed)
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches
      || (window.navigator as Navigator & { standalone?: boolean }).standalone === true;

    // Check if user dismissed this card specifically
    const isDismissed = localStorage.getItem(CARD_DISMISSED_KEY);

    // Show only if not installed and not dismissed
    if (!isStandalone && !isDismissed) {
      card.classList.add('show');
    }
  }

  // Check after short delay to allow page to settle
  setTimeout(checkAndShowCard, 100);

  // Install button
  installBtn?.addEventListener('click', async () => {
    await triggerInstall();
    // Hide card after install attempt
    localStorage.setItem(CARD_DISMISSED_KEY, 'true');
    if (card) {
      card.classList.remove('show');
    }
  });

  // Dismiss button
  dismissBtn?.addEventListener('click', () => {
    localStorage.setItem(CARD_DISMISSED_KEY, 'true');
    if (card) {
      card.classList.remove('show');
    }
  });
</script>
